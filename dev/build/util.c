#include <stdbool.h>
#include <stddef.h>
#include <stdio.h>
#include <string.h>

static void writeAsJSONString(FILE *f, const char *const s, const size_t len) {
  size_t i = 0;
  while (i < len) {
    const char c = s[i++];
    if (c == '"')
      fputs("\\\"", f);
    else
      fputc(c, f);
  }
}

static void writeRow(FILE *f, const char *const row, const size_t row_len,
                     bool *const first) {
  if (*first) {
    *first = false;
  } else {
    fputs(",\n", f);
  }
  fputs("        \"", f);
  writeAsJSONString(f, row, row_len);
  fputc('"', f);
}

static void writeIncDefJSONRows(FILE *f, const char *const *const incdefs,
                                const size_t incdefs_len) {
  bool first = true;
  if (incdefs_len > 0)
    writeRow(f, incdefs[0], strlen(incdefs[0]), &first);
  for (size_t i = 1; i < incdefs_len; i++) {
    writeRow(f, incdefs[i], strlen(incdefs[i]), &first);
  }
}

static void writeVSCodeInfo(const char *const *const includes,
                            const size_t includes_len,
                            const char *const *const defines,
                            const size_t defines_len) {
  FILE *f = fopen(".vscode/c_cpp_properties.json", "wb");

  fputs("// Generated by build.c\n{\n  \"configurations\": [\n    {\n      "
        "\"name\": \"Linux\",\n      "
        "\"includePath\": [\n",
        f);

  writeIncDefJSONRows(f, includes, includes_len);

  fputs("\n      ],\n      \"defines\": [\n", f);

  writeIncDefJSONRows(f, defines, defines_len);

  fputs("\n      ]\n    }\n  ],\n  \"version\": 4\n}\n", f);

  fclose(f);
}
